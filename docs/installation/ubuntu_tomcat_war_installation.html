## GAIN SUPER ADMIN
sudo su

# INSTALL UNZIP
sudo apt install unzip


## INSTALL POSTGRESQL
sudo apt install postgresql

# CONNECT AS POSTGRES
sudo su postgres
 
# CREATE DATABASE USER CONNECTED AS POSTGRES
createuser --no-superuser --username postgres --pwprompt axelor

#CREATE DB
createdb --owner=axelor axelor

#START POSTGRE INTERACTIVE COMMAND
psql

#GRANT PRIVILEGES
GRANT ALL PRIVILEGES ON DATABASE axelor TO axelor;  
GRANT ALL PRIVILEGES ON SCHEMA public TO axelor;  
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO axelor; 
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON TABLES TO axelor;   
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO axelor; 
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON SEQUENCES TO axelor; 
GRANT ALL PRIVILEGES ON ALL FUNCTIONS IN SCHEMA public TO axelor; 
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL PRIVILEGES ON FUNCTIONS TO axelor;

#QUIT INTERACTIVE
\q

#BACK TO USER
exit

#INSTALL JDK
sudo apt install default-jdk

# CHECK JDK
java -version

# CREATE DIRECTORY
mkdir /opt/src

# HEAD TO DIRECTORY
cd /opt/src

# DL
wget https://dlcdn.apache.org/tomcat/tomcat-9/v9.0.102/bin/apache-tomcat-9.0.102.tar.gz --no-check-certificate


#EXTRACT
tar -xzf apache-tomcat-9.0.102.tar.gz

#SYMBOLIC LINK FROM SRC to OPT
ln -s /opt/src/apache-tomcat-9.0.102 /opt/default-tomcat

#TOMCAT LOGS CONF
sed -z -r -i 's/(<Valve className="org.apache.catalina.valves.AccessLogValve".*\/>)/<!--\1-->/' /opt/default-tomcat/conf/server.xml


# CHECK JAVA INSTALLATION PATH
sudo update-java-alternatives -l
# java-1.11.0-openjdk-amd64      1111       /usr/lib/jvm/java-1.11.0-openjdk-amd64



# CREATE TOMCAT SERVICE FILE
sudo nano /etc/systemd/system/tomcat.service

 # APPEND LINES TO TOMCAT SERVICE FILE
[Unit]
Description=Apache Tomcat Web Application Container
After=network.target
[Service]
Type=forking
User=tomcat
Group=tomcat
Environment="JAVA_HOME=/usr/lib/jvm/java-1.11.0-openjdk-amd64"
Environment="CATALINA_HOME=/opt/default-tomcat"
Environment="CATALINA_PID=/opt/default-tomcat/temp/tomcat.pid"
Environment="CATALINA_OPTS=-Xms512M -Xmx1024M -server -XX:+UseParallelGC"
ExecStart=/opt/default-tomcat/bin/startup.sh
ExecStop=/opt/default-tomcat/bin/shutdown.sh
[Install]
WantedBy=multi-user.target


# SETUP TOMCAT GROUP and USER
sudo groupadd tomcat
sudo useradd -s /bin/false -g tomcat -d /opt/default-tomcat tomcat

# GIVE TOMCAT USER PERMISSION ON TOMCAT FOLDER
sudo chown -RH tomcat: /opt/default-tomcat

# RELOAD SERVICES
sudo systemctl daemon-reload
sudo systemctl enable tomcat

# START TOMCAT

sudo systemctl start tomcat
sudo systemctl status tomcat

# AXELOR WAR
cd /opt/src/
wget https://github.com/axelor/open-suite-webapp/releases/download/v8.3.3/axelor-erp-v8.3.3.war
unzip axelor-erp-v8.3.3.war -d axelor
ln -s /opt/src/axelor /opt/default-tomcat/webapps/
nano /opt/src/axelor/WEB-INF/classes/axelor-config.properties
#change db name and password
#set demo to “true”


# GIVE PERMISSION ON AXELOR FOLDER TO TOMCAT USER

chown -R tomcat:tomcat /opt/src/axelor
chown -R tomcat:tomcat /opt/default-tomcat/webapps/axelor


# STOP TOMCAT
systemctl stop tomcat

# START TOMCAT 
systemctl start tomcat

# LOGS
tail -f /opt/default-tomcat/logs/catalina.out


#IF ADMIN ACCOUNT IS DISABLED
sudo -u postgres psql

#connect to db
\c axelor

#list all tables
\dt

#list columns in table
\d auth_user

#show value of field
SELECT code,blocked FROM auth_user;

#UPDATE
UPDATE auth_user SET blocked = 'f' WHERE code = 'demo';
